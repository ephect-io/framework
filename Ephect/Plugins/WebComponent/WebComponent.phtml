<?php

namespace Ephect\Plugins\WebComponent;

use Ephect\Framework\Components\WebComponent;
use Ephect\Framework\Core\Builder;
use Ephect\Framework\IO\Utils;

use function Ephect\Hooks\useEffect;

function WebComponent($children)
{

    useEffect(function($children, /* string */ $tag, /* string */ $args) {

        if($children === null) {

            $tag = "no-name";
            $props = "";
            
            return;
        }

        $motherUID = $children->getMotherUID();
        $name = $children->getClass();

        $srcFilename = $motherUID . DIRECTORY_SEPARATOR . $name . ".component" . PREHTML_EXTENSION;

        $props = $children->props();

        $props = isset($props->props) ? $props->props : $props;

        $args = [];
        foreach($props as $key => $value) {
            $args[] =  $key . '="' . $value . '"';
        }

        $args = implode(" ", $args);

        $motherUID = $children->getMotherUID();
        $name = $children->getClass();

        $manifestFilename = 'manifest.json';
        $manifestCache = CACHE_DIR . $motherUID . DIRECTORY_SEPARATOR . $manifestFilename;

        if(!file_exists($manifestCache)) {
            copy(CUSTOM_WEBCOMPONENTS_ROOT . $name . DIRECTORY_SEPARATOR . $manifestFilename, $manifestCache);
        }

        $manifestJson = Utils::safeRead($manifestCache);
        $manifest = json_decode($manifestJson);

        $tag = $manifest->tag;

        $finalJs = RUNTIME_JS_DIR . $name . JS_EXTENSION;

        if(!file_exists($finalJs)) {
            $comp = new WebComponent($name, $motherUID);
            $html = $comp->renderHTML($srcFilename, $props);

            Utils::safeWrite($finalJs, $html);
        } else {
        }
    });

    return (<<< HTML
        <{{ tag }} {{ args }} />
    HTML);
}

<?php

namespace Ephect\Plugins\Route;

use Ephect\Components\Component;
use Ephect\Plugins\Router\RouterService;
use Ephect\Registry\ComponentRegistry;
use Ephect\Registry\HttpErrorRegistry;

use function Ephect\Hooks\useEffect;

function Route($props)
{
    useEffect(function () use($props) {
        $routeBuilder = new RouteBuilder($props);
        $route = $routeBuilder->build();

        $router = new RouterService();
        $router->addRoute($route);
        $router->saveRoutes();

        /**
         * BEGIN code to remove if CLI build is mandatory
         */
        if(!IS_WEB_APP) {
            return;
        }

        $error = $route->getError();
        
        [$path, $query, $code] = $router->matchRoute($route);

        $code = $error ?: $code;

        if ($code !== 200) {
            http_response_code($code);
            $path = HttpErrorRegistry::read($code);

            if (ComponentRegistry::read($path) === null) {
                $html = 'Page not found';
                $html = ($code === 401) ? 'Bad request' : $html;
                return;
            }
        }

        $comp = new Component($path);
        $comp->render($query);
        /**
         * END code to remove if CLI build is mandatory
         */

    });

    return (<<< HTML
        
    HTML);
}

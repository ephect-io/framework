<?php

namespace Ephect\Plugins\Router;

use Ephect\Components\Compiler;
use Ephect\Components\Component;
use Ephect\Registry\ComponentRegistry;
use Ephect\Registry\HttpErrorRegistry;
use Ephect\Registry\RouteRegistry;

use function Ephect\Hooks\useEffect;
use function Ephect\Hooks\useState;

function Router($children)
{
    useEffect(function () use (/* bool */&$hasRouted, /* object */ &$service, /* string */ &$path, /* string */ &$html) {

        $service = new RouterService;

        if ($service->routesAreCached()) {

            [$path, $query, $error, $code] = $service->doRouting();

            useState(["pageState" => ['path' => $path, 'query' => $query, 'error' => $error, 'code' => $code, ]]);

            $service->renderRoute($html);

            $hasRouted = true;
        }
    });

    return (<<< HTML
        {? 
            if({hasRouted}) { 
                echo {html};
                return;
            } 
        ?}
        {{ children }}
        {? 
            {service}->renderRoute({path}, {html});

            rename(RouteRegistry::getCacheFilename(), CACHE_DIR . 'routes.json');
            Compiler::purgeCopies();
        ?}
    HTML);
}
